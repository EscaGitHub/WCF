<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>D:\!Work\!GIT\SWR-Conf\Source\SWR-ConfiguratorAPI\SWR-ConfiguratorAPI\Logic\Settings\SettingsManager.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Xml;
using Dapper;
using Microsoft.AspNetCore.Razor.Language;
using Nest;
using Swr.Configurator.Common.Data;
using Swr.Configurator.Common.Data.ObjectModel;
using Swr.Configurator.Common.Serialization;
using SWR.ConfiguratorApi.Data;
using SWR.ConfiguratorApi.Data.Db;
using SWR.ConfiguratorApi.Logic.Converters;
using SWR.ConfiguratorApi.Logic.Settings.Checks;
using Attribute = SWR.ConfiguratorApi.Data.Db.Attribute;
using SettingsCommom = Swr.Configurator.Common.Settings;

namespace SWR.ConfiguratorApi.Logic.Settings
{
    public class SettingsManager
    {
        public List&lt;string&gt; Errors = new List&lt;string&gt;();

        public string ReadSettings()
        {
            string result = string.Empty;

            try
            {
                var settings = new SettingsForDb();
                //Dictionary&lt;ComponentType, List&lt;Guid&gt;&gt; componentTypes = new Dictionary&lt;ComponentType, List&lt;Guid&gt;&gt;();
                List&lt;ComponentType&gt; componentTypes = null;
                List&lt;SpecificationType&gt; specificationTypes = null;
                List&lt;Attribute&gt; attributes = null;
                using (var dbController = new DbController())
                {
                    dbController.Connect();

                    componentTypes = dbController.GetComponentTypes().ToList();

                    //foreach (var dbComponentType in dbComponentTypes)
                    //{
                    //    componentTypes.Add(dbComponentType, dbController.GetSpecificationTypesForComponentType(dbComponentType.Id));
                    //}

                    specificationTypes = dbController.GetSpecificationTypes().ToList();

                    attributes = dbController.GetAttributes().ToList();

                    dbController.SaveClose();
                }

                if (componentTypes != null) settings.ComponentTypes = componentTypes;
                if (specificationTypes != null) settings.SpecificationTypes = specificationTypes;
                if (attributes != null) settings.Attributes = attributes;

                var resultSettings = new SettingsCommom.Settings();

                foreach (var dbSettingsAttribute in settings.Attributes)
                {
                    var attribute = new AttributeObject();
                    attribute.DbAttributeId = dbSettingsAttribute.ID;
                    attribute.Name = dbSettingsAttribute.Name;
                    switch (dbSettingsAttribute.DataType)
                    {
                        case &quot;String&quot;:
                            attribute.DataType = AttributeDataType.String;
                            break;
                        case &quot;Integer&quot;:
                            attribute.DataType = AttributeDataType.Integer;
                            break;
                        case &quot;Double&quot;:
                            attribute.DataType = AttributeDataType.Double;
                            break;
                    }

                    //attribute.DataType = dbSettingsAttribute.DataType;
                    if (dbSettingsAttribute.AttributeTypeName == &quot;Card&quot;)
                    {
                        attribute.Type = AttributeTypeEnum.Card;
                    }

                    if (dbSettingsAttribute.AttributeTypeName == &quot;Link&quot;)
                    {
                        attribute.Type = AttributeTypeEnum.Link;
                    }

                    attribute.IsUnique = dbSettingsAttribute.Unique;

                    resultSettings.Attributes.Add(attribute);
                }

                foreach (var dbComponentType in settings.ComponentTypes)
                {
                    resultSettings.ComponentTypes.Add(
                        ComponentTypeConverter.GetComponentTypeObject(dbComponentType, resultSettings.Attributes));
                }

                foreach (var dbSpecificationType in settings.SpecificationTypes)
                {
                    resultSettings.SpecificationTypes.Add(
                        SpecificationTypeConverter.GetSpecificationTypeObject(dbSpecificationType,
                            resultSettings.Attributes));
                }


                result = resultSettings.Serialize();
            }
            catch (Exception e)
            {
                Console.WriteLine(e);
                throw;
            }


            return result;
        }

        /// &lt;summary&gt;
        /// Метод сохранения настроек
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xmlSettings&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public bool SaveSettings(string xmlSettings)
        {
            var settings = xmlSettings.Deserialize&lt;SettingsCommom.Settings&gt;();


            if (!Check(settings)) return false;

            var oldSettings = ReadSettings().Deserialize&lt;SettingsCommom.Settings&gt;();
            using (var dbController = new DbController())
            {
                dbController.Connect();

                var newAddedAttributes = UpdateCommonAttributes(dbController, settings.Attributes, settings, oldSettings);

                dbController.SaveClose();

                SetAttributeGuidToTypes(settings, newAddedAttributes);

                dbController.Connect();

                var allowSpecificationRelTypeId = dbController.GetRelationTypeIdByName(&quot;AllowSpecification&quot;);
                var includeComponentRelTypeId = dbController.GetRelationTypeIdByName(&quot;IncludeComponentType&quot;);

                DeleteTypeRelations(settings, oldSettings, allowSpecificationRelTypeId, includeComponentRelTypeId, dbController);

                var newComponentTypes = UpdateComponentTypes(dbController, settings.ComponentTypes, oldSettings, settings);


                var newSpecificationTypes = UpdateSpecificationTypes(dbController, settings.SpecificationTypes, oldSettings);

                UpdateTypeRelations(settings, oldSettings, dbController, newComponentTypes, newSpecificationTypes, allowSpecificationRelTypeId, includeComponentRelTypeId);
                dbController.SaveClose();
            }

            return true;
        }

        private void DeleteTypeRelations(SettingsCommom.Settings settings, SettingsCommom.Settings oldSettings, Guid allowSpecificationRelTypeId, Guid includeComponentRelTypeId, DbController dbController)
        {
            var deletedTypeRelations = new List&lt;TypeRelation&gt;();

            foreach (var componentType in settings.ComponentTypes)
            {
                var oldSettingsComponentType = oldSettings.ComponentTypes
                    .FirstOrDefault(t =&gt; t.Name == componentType.Name);
                if (oldSettingsComponentType != null)
                {
                    var deletedSpecificationTypeNames = oldSettingsComponentType.SpecificationTypeNames
                        .FindAll(t =&gt; !componentType.SpecificationTypeNames.Contains(t));

                    foreach (var deletedSpecificationTypeName in deletedSpecificationTypeNames)
                    {
                        var typeRelation = new TypeRelation();
                        //typeRelation.Id = Guid.NewGuid();
                        typeRelation.RelationTypeId = allowSpecificationRelTypeId;//dbController.GetRelationTypeIdByName(&quot;AllowSpecification&quot;);
                        typeRelation.ComponentTypeId = componentType.ID;
                        typeRelation.SpecificationTypeId = oldSettings.SpecificationTypes.FirstOrDefault(t =&gt; t.Name == deletedSpecificationTypeName).ID;
                        deletedTypeRelations.Add(typeRelation);
                    }

                }
            }

            //var deletedComponentTypes = 

            foreach (var specificationType in settings.SpecificationTypes)
            {
                var oldSettingsSpecificationType = oldSettings.SpecificationTypes
                    .FirstOrDefault(t =&gt; t.Name == specificationType.Name);
                if (oldSettingsSpecificationType != null)
                {
                    var deletedComponentTypeNames = oldSettingsSpecificationType.AllowComponentTypeNames
                        .FindAll(t =&gt; !specificationType.AllowComponentTypeNames.Contains(t));

                    foreach (var deletedComponentTypeName in deletedComponentTypeNames)
                    {
                        var typeRelation = new TypeRelation();
                        //typeRelation.Id = Guid.NewGuid();
                        typeRelation.RelationTypeId = includeComponentRelTypeId;//dbController.GetRelationTypeIdByName(&quot;AllowSpecification&quot;);
                        typeRelation.ComponentTypeId = oldSettings.ComponentTypes
                            .FirstOrDefault(t =&gt; t.Name == deletedComponentTypeName).ID;
                        typeRelation.SpecificationTypeId = specificationType.ID;//oldSettings.SpecificationTypes.FirstOrDefault(t =&gt; t.Name == deletedSpecificationTypeName).ID;
                        deletedTypeRelations.Add(typeRelation);
                    }

                }
            }

            dbController.DeleteTypeRelations(deletedTypeRelations);
        }

        private void UpdateTypeRelations(SettingsCommom.Settings settings, SettingsCommom.Settings oldSettings, DbController dbController, Dictionary&lt;string, Guid&gt; newComponentTypes, Dictionary&lt;string, Guid&gt; newSpecificationTypes, Guid allowSpecificationRelTypeId, Guid includeComponentRelTypeId)
        {
            var addedTypeRelations = new List&lt;TypeRelation&gt;();
            
            foreach (var componentType in settings.ComponentTypes)
            {
                foreach (var specificationTypeName in componentType.SpecificationTypeNames)
                {
                    var foundSpecificationType =
                        settings.SpecificationTypes.FirstOrDefault(t =&gt;
                            t.Name == specificationTypeName);

                    var oldComponentType = oldSettings.ComponentTypes.FirstOrDefault(t =&gt; t.ID == componentType.ID);
                    

                    if (foundSpecificationType != null)
                    {
                        var typeRelationExist = oldComponentType != null &amp;&amp; (bool)oldComponentType?.SpecificationTypeNames.Contains(foundSpecificationType.Name);
                        if (!typeRelationExist)
                        {
                            var typeRelation = new TypeRelation();
                            typeRelation.Id = Guid.NewGuid();
                            typeRelation.RelationTypeId =
                                allowSpecificationRelTypeId; 
                            if (componentType.ID == Guid.Empty)
                            {
                                typeRelation.ComponentTypeId = newComponentTypes[componentType.Name];
                            }
                            else
                            {
                                typeRelation.ComponentTypeId = componentType.ID;
                            }
                            
                            if (foundSpecificationType.ID == Guid.Empty)
                            {
                                typeRelation.SpecificationTypeId = newSpecificationTypes[specificationTypeName];
                            }
                            else
                            {
                                if (oldComponentType != null)
                                {
                                    typeRelation.SpecificationTypeId = foundSpecificationType.ID;
                                }
                            }
                            addedTypeRelations.Add(typeRelation);
                        }
                    }

                }
            }

            foreach (var specificationType in settings.SpecificationTypes)
            {
                foreach (var componentTypeName in specificationType.AllowComponentTypeNames)
                {
                    var foundComponentType =
                        settings.ComponentTypes.FirstOrDefault(t =&gt; t.Name == componentTypeName);

                    var oldSpecificationType = oldSettings.SpecificationTypes.FirstOrDefault(t =&gt; t.ID == specificationType.ID);

                    if (foundComponentType != null)
                    {
                        var typeRelationExist = oldSpecificationType != null &amp;&amp; (bool)oldSpecificationType?.AllowComponentTypeNames.Contains(foundComponentType.Name);
                        if (!typeRelationExist)
                        {
                            var typeRelation = new TypeRelation();
                            typeRelation.Id = Guid.NewGuid();
                            typeRelation.RelationTypeId =
                                includeComponentRelTypeId; 
                            if (foundComponentType.ID == Guid.Empty)
                            {
                                typeRelation.ComponentTypeId = newComponentTypes[componentTypeName];
                            }
                            else
                            {
                                typeRelation.ComponentTypeId = foundComponentType.ID;
                            }

                            if (specificationType.ID == Guid.Empty)
                            {
                                typeRelation.SpecificationTypeId = newSpecificationTypes[specificationType.Name];
                            }
                            else
                            {
                                typeRelation.SpecificationTypeId = specificationType.ID;
                            }
                            
                            addedTypeRelations.Add(typeRelation);
                        }
                    }
                }
            }

            dbController.AddTypeRelations(addedTypeRelations);
            
        }

        public bool IsAllowDeleteComponentType(Guid componentTypeId)
        {
            var result = false;

            using (var dbController = new DbController())
            {
                dbController.Connect();

                //var guid = new Guid(componentTypeId);

                result = dbController.IsAllowDeleteComponentType(componentTypeId);

                dbController.SaveClose();
            }

            return result;
        }

        public bool IsAllowDeleteSpecificationType(Guid specificationTypeId)
        {
            var result = false;
            using (var dbController = new DbController())
            {
                dbController.Connect();

                //var guid = new Guid(specificationTypeId);

                result = dbController.IsAllowDeleteSpecificationType(specificationTypeId);

                dbController.SaveClose();
            }


            return result;
        }

        private void SetAttributeGuidToTypes(SettingsCommom.Settings settings, Dictionary&lt;string, Guid&gt; newAddedAttributes)
        {

            var foundAttributes = settings.ComponentTypes.SelectMany(t =&gt; t.Attributes).Where(t =&gt; t.Attribute != null &amp;&amp; newAddedAttributes.ContainsKey(t.Attribute.Name));

            foreach (var attributeForTypeObject in foundAttributes)
            {
                attributeForTypeObject.Attribute.DbAttributeId = newAddedAttributes[attributeForTypeObject.Attribute.Name];
            }

            foundAttributes = settings.SpecificationTypes.SelectMany(t =&gt; t.Attributes).Where(t =&gt; t.Attribute != null &amp;&amp; newAddedAttributes.ContainsKey(t.Attribute.Name));

            foreach (var attributeForTypeObject in foundAttributes)
            {
                attributeForTypeObject.Attribute.DbAttributeId = newAddedAttributes[attributeForTypeObject.Attribute.Name];
            }

        }

        private Dictionary&lt;string, Guid&gt; UpdateCommonAttributes(DbController dbController, List&lt;AttributeObject&gt; settingsAttributes, SettingsCommom.Settings settings, SettingsCommom.Settings oldSettings)
        {
            var result = new Dictionary&lt;string, Guid&gt;();
            var newCommonAttributes = settingsAttributes.Where(t =&gt; t.DbAttributeId == Guid.Empty).ToList();
            var updatedCommonAttributes = settingsAttributes.Where(t =&gt; t.DbAttributeId != Guid.Empty).ToList();
            var deletedCommonAttributes = oldSettings.Attributes.Where(t =&gt; settingsAttributes.FirstOrDefault(l =&gt; l.DbAttributeId == t.DbAttributeId) == null).ToList();//settingsAttributes.Where(t =&gt; t.IsDeleted).ToList();

            if (newCommonAttributes.Count != 0)
            {
                var newDbAttributes = new List&lt;Attribute&gt;();

                foreach (var attributeObject in newCommonAttributes)
                {
                    var dbAttribute = new Attribute();
                    dbAttribute.ID = Guid.NewGuid();

                    dbAttribute.Name = attributeObject.Name;
                    result.Add(dbAttribute.Name, dbAttribute.ID);

                    switch (attributeObject.DataType)
                    {
                        case AttributeDataType.String:
                            dbAttribute.DataType = &quot;String&quot;;
                            break;
                        case AttributeDataType.Double:
                            dbAttribute.DataType = &quot;Double&quot;;
                            break;
                        case AttributeDataType.Integer:
                            dbAttribute.DataType = &quot;Integer&quot;;
                            break;
                    }

                    var typeName = string.Empty;
                    switch (attributeObject.Type)
                    {
                        case AttributeTypeEnum.Card:
                            typeName = &quot;Card&quot;;
                            break;
                        case AttributeTypeEnum.Link:
                            typeName = &quot;Link&quot;;
                            break;
                    }

                    dbAttribute.Unique = attributeObject.IsUnique;

                    dbAttribute.AttrTypeId = dbController.GetAttributeTypeIdByName(typeName);


                    newDbAttributes.Add(dbAttribute);
                }

                foreach (var newDbAttribute in newDbAttributes)
                {
                    dbController.AddAttribute(newDbAttribute);

                }
            }

            if (updatedCommonAttributes.Count != 0)
            {
                var updatedDbAttributes = new List&lt;Attribute&gt;();

                foreach (var updatedAttribute in updatedCommonAttributes)
                {
                    var dbAttribute = new Attribute();
                    dbAttribute.ID = updatedAttribute.DbAttributeId;
                    dbAttribute.Name = updatedAttribute.Name;
                    switch (updatedAttribute.DataType)
                    {
                        case AttributeDataType.String:
                            dbAttribute.DataType = &quot;String&quot;;
                            break;
                        case AttributeDataType.Double:
                            dbAttribute.DataType = &quot;Double&quot;;
                            break;
                        case AttributeDataType.Integer:
                            dbAttribute.DataType = &quot;Integer&quot;;
                            break;
                    }

                    var typeName = string.Empty;
                    switch (updatedAttribute.Type)
                    {
                        case AttributeTypeEnum.Card:
                            typeName = &quot;Card&quot;;
                            break;
                        case AttributeTypeEnum.Link:
                            typeName = &quot;Link&quot;;
                            break;
                    }

                    dbAttribute.Unique = updatedAttribute.IsUnique;

                    dbAttribute.AttrTypeId = dbController.GetAttributeTypeIdByName(typeName);

                    updatedDbAttributes.Add(dbAttribute);
                }

                dbController.UpdateAttributes(updatedDbAttributes);
            }

            if (deletedCommonAttributes.Count != 0)
            {

                var dbDeletedAttributes = new List&lt;Attribute&gt;();

                foreach (var deletedAttribute in deletedCommonAttributes)
                {
                    if (dbController.IsAllowDeleteAttribute(deletedAttribute.DbAttributeId) &amp;&amp; !CheckExistAttributeInType(deletedAttribute, settings))
                    {
                        var dbAttribute = new Attribute();
                        dbAttribute.ID = deletedAttribute.DbAttributeId;
                        dbAttribute.IsDeleted = deletedAttribute.IsDeleted;
                        dbDeletedAttributes.Add(dbAttribute);
                    }
                }

                dbController.DeleteAttributes(dbDeletedAttributes);
            }

            return result;
        }

        private bool CheckExistAttributeInType(AttributeObject attribute, SettingsCommom.Settings settings)
        {
            var result = false;

            var componentTypeAttributesExist = settings.ComponentTypes.SelectMany(t =&gt; t.Attributes)
                .Any(t =&gt; t.Attribute.DbAttributeId == attribute.DbAttributeId);

            var specificationTypeAttributesExist = settings.SpecificationTypes.SelectMany(t =&gt; t.Attributes)
                .Any(t =&gt; t.Attribute.DbAttributeId == attribute.DbAttributeId);

            result = componentTypeAttributesExist &amp;&amp; specificationTypeAttributesExist;

            return result;
        }

        private Dictionary&lt;string, Guid&gt; UpdateSpecificationTypes(DbController dbController,
            List&lt;SpecificationTypeObject&gt; settingsSpecificationTypes, SettingsCommom.Settings oldSettings)
        {
            var result = new Dictionary&lt;string, Guid&gt;();
            var newSpecificationTypes = settingsSpecificationTypes.Where(t =&gt; t.ID == Guid.Empty).ToList();
            var updatedSpecificationTypes = settingsSpecificationTypes.Where(t =&gt; t.ID != Guid.Empty).ToList();

            var deletedSpecificationTypes =
                oldSettings.SpecificationTypes.Where(t =&gt; settingsSpecificationTypes.FirstOrDefault(l =&gt; l.ID == t.ID) == null).ToList();


            if (newSpecificationTypes.Count != 0) // TODO: добавление новых типов не рассматривалось
            {
                var newDbSpecificationTypes = new List&lt;SpecificationType&gt;();
                foreach (var specificationTypeObject in newSpecificationTypes)
                {
                    var specificationDbType =
                        SpecificationTypeConverter.GetDbSpecificationType(specificationTypeObject);
                    result.Add(specificationDbType.Name, specificationDbType.ID);
                    newDbSpecificationTypes.Add(specificationDbType);
                }

                //var typeRelations = SpecificationTypeConverter.GetTypeRelationsForSpecificationType(newDbSpecificationTypes, dbController);

                dbController.AddSpecificationTypes(newDbSpecificationTypes);
                var newSpecificationTypeAttributes = newDbSpecificationTypes.SelectMany(t =&gt; t.SpecificationTypeAttributes).ToList();
                dbController.AddSpecificationTypeAttributes(newSpecificationTypeAttributes);

                //dbController.AddTypeRelations(typeRelations);
            }

            if (updatedSpecificationTypes.Count != 0)
            {
                var updatedDbSpecificationTypes = new List&lt;SpecificationType&gt;();
                foreach (var updatedSpecificationType in updatedSpecificationTypes)
                {
                    updatedDbSpecificationTypes.Add(SpecificationTypeConverter.GetDbSpecificationType(updatedSpecificationType));
                }

                //var addedTypeRelations = SpecificationTypeConverter.GetAddedTypeRelations(updatedDbSpecificationTypes, dbController);

                //var deletedTypeRelations =
                //    SpecificationTypeConverter.GetDeletedTypeRelations(updatedDbSpecificationTypes,
                //        dbController);

                //if (addedTypeRelations != null &amp;&amp; addedTypeRelations.Count != 0)
                //{
                //    dbController.AddTypeRelations(addedTypeRelations);
                //}

                //if (deletedTypeRelations != null &amp;&amp; deletedTypeRelations.Count != 0)
                //{
                //    dbController.DeleteTypeRelations(deletedTypeRelations);
                //}

                dbController.UpdateSpecificationTypes(updatedDbSpecificationTypes);

                var addedSpecificationTypeAttributes = updatedDbSpecificationTypes.SelectMany(t =&gt; t.SpecificationTypeAttributes).Where(t =&gt; t.IsNew).ToList();

                if (addedSpecificationTypeAttributes.Count != 0)
                {
                    dbController.AddSpecificationTypeAttributes(addedSpecificationTypeAttributes);
                }

                var updatedSpecificationTypeAttributes = updatedDbSpecificationTypes.SelectMany(t =&gt; t.SpecificationTypeAttributes).Where(t =&gt; !t.IsNew).ToList();

                dbController.UpdateSpecificationTypeAttributes(updatedSpecificationTypeAttributes);
            }

            if (deletedSpecificationTypes.Count != 0)
            {
                var deletedDbSpecificationTypes = new List&lt;SpecificationType&gt;();

                foreach (var deletedSpecificationType in deletedSpecificationTypes)
                {
                    if (dbController.IsAllowDeleteSpecificationType(deletedSpecificationType.ID))
                    {
                        deletedDbSpecificationTypes.Add(
                            SpecificationTypeConverter.GetDbSpecificationType(deletedSpecificationType));
                    }
                }

                dbController.DeleteTypeRelationsForSpecificationTypes(deletedDbSpecificationTypes);

                var deletedSpecificationTypeAttributes = deletedDbSpecificationTypes.SelectMany(t =&gt; t.SpecificationTypeAttributes).ToList();
                dbController.DeleteSpecificationTypeAttributes(deletedSpecificationTypeAttributes);

                dbController.DeleteSpecificationTypes(deletedSpecificationTypes);
            }

            return result;
        }

        private Dictionary&lt;string, Guid&gt; UpdateComponentTypes(DbController dbController, List&lt;ComponentTypeObject&gt; settingsComponentTypes,
            SettingsCommom.Settings oldSettings, SettingsCommom.Settings newSettings)
        {
            var result = new Dictionary&lt;string, Guid&gt;();
            var newComponentTypes = settingsComponentTypes.Where(t =&gt; t.ID == Guid.Empty).ToList();
            var updatedComponentTypes = settingsComponentTypes.Where(t =&gt; t.ID != Guid.Empty).ToList();
            var deletedComponentTypes =
                oldSettings.ComponentTypes.Where(t =&gt; settingsComponentTypes.FirstOrDefault(l =&gt; l.ID == t.ID) == null).ToList();

            if (newComponentTypes.Count != 0) // TODO: добавление новых типов не рассматривалось
            {
                var newDbComponentTypes = new List&lt;ComponentType&gt;();

                foreach (var componentTypeObject in newComponentTypes)
                {
                    var newDbComponentType = ComponentTypeConverter.GetDbComponentType(componentTypeObject);
                    result.Add(newDbComponentType.Name, newDbComponentType.Id);
                    newDbComponentTypes.Add(newDbComponentType);
                }

                //var typeRelations = ComponentTypeConverter.GetTypeRelationsForComponentTypes(newDbComponentTypes, dbController);

                dbController.AddComponentTypes(newDbComponentTypes);

                var newComponentTypeAttributes = newDbComponentTypes.SelectMany(t =&gt; t.ComponentTypeAttributes).ToList();

                dbController.AddComponentTypeAttributes(newComponentTypeAttributes);

                //dbController.AddTypeRelations(typeRelations);
            }

            if (updatedComponentTypes.Count != 0)
            {
                var updateDbComponentTypes = new List&lt;ComponentType&gt;();

                foreach (var updatedComponentType in updatedComponentTypes)
                {
                    updateDbComponentTypes.Add(ComponentTypeConverter.GetDbComponentType(updatedComponentType));
                }

                //var addedTypeRelations = ComponentTypeConverter.GetAddedTypeRelations(updateDbComponentTypes, dbController, newSettings);
                
               // var deletedTypeRelations = ComponentTypeConverter.GetDeletedTypeRelations(updatedComponentTypes, dbController);

                ////if (addedTypeRelations != null &amp;&amp; addedTypeRelations.Count != 0)
                ////{
                ////    dbController.AddTypeRelations(addedTypeRelations);
                ////}

                ////if (deletedTypeRelations != null &amp;&amp; deletedTypeRelations.Count != 0)
                ////{
                ////    dbController.DeleteTypeRelations(deletedTypeRelations);
                ////}


                dbController.UpdateComponentTypes(updateDbComponentTypes);

                var addedComponentTypeAttributes = updateDbComponentTypes.SelectMany(t =&gt; t.ComponentTypeAttributes).Where(t =&gt; t.IsNew).ToList();

                if (addedComponentTypeAttributes.Count != 0)
                {
                    dbController.AddComponentTypeAttributes(addedComponentTypeAttributes);
                }

                //var updatedComponentTypeAttributes = updateDbComponentTypes.SelectMany(t =&gt; t.ComponentTypeAttributes).Where(t =&gt; t.Id != Guid.Empty).ToList();
                var updatedComponentTypeAttributes = updateDbComponentTypes.SelectMany(t =&gt; t.ComponentTypeAttributes).Where(t =&gt; !t.IsNew).ToList(); // Поменял условие проверки
                dbController.UpdateComponentTypeAttributes(updatedComponentTypeAttributes);
            }

            if (deletedComponentTypes.Count != 0)
            {
                var deletedDbComponentTypes = new List&lt;ComponentType&gt;();

                foreach (var deletedComponentType in deletedComponentTypes)
                {
                    if (dbController.IsAllowDeleteComponentType(deletedComponentType.ID))
                    {
                        deletedDbComponentTypes.Add(ComponentTypeConverter.GetDbComponentType(deletedComponentType));
                    }
                }

                dbController.DeleteTypeRelationsForComponentTypes(deletedDbComponentTypes);
                var deletedComponentTypeAttributes = deletedDbComponentTypes.SelectMany(t =&gt; t.ComponentTypeAttributes).ToList();
                dbController.DeleteComponentTypeAttriutes(deletedComponentTypeAttributes);

                dbController.DeleteComponentTypes(deletedDbComponentTypes);
            }

            return result;
        }

        private bool Check(SettingsCommom.Settings settings)
        {
            Errors.Clear();

            var result = true;

            var oldSetting = ReadSettings().Deserialize&lt;SettingsCommom.Settings&gt;();

            var fabric = new ChecksSettingsFabric(oldSetting, settings);

            if (!fabric.Run())
            {
                Errors = fabric.Errors;

                result = false;
            }

            return result;
        }

        public bool IsAllowDeleteAttribute(Guid attributeId)
        {
            var result = false;

            using (var dbController = new DbController())
            {
                dbController.Connect();

                //var guid = new Guid(componentTypeId);

                result = dbController.IsAllowDeleteAttribute(attributeId);

                dbController.SaveClose();
            }

            return result;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,57,1],[26,9,26,10,1],[27,13,27,42,1],[30,13,30,14,1],[31,17,31,52,1],[33,17,33,59,1],[34,17,34,67,1],[35,17,35,51,1],[36,24,36,61,1],[37,17,37,18,1],[38,21,38,44,1],[40,21,40,80,1],[47,21,47,88,1],[49,21,49,72,1],[51,21,51,46,1],[52,17,52,18,1],[54,17,54,44,1],[54,45,54,86,1],[55,17,55,48,1],[55,49,55,98,1],[56,17,56,40,1],[56,41,56,74,1],[58,17,58,68,1],[60,17,60,24,1],[60,26,60,49,1],[60,50,60,52,1],[60,53,60,72,1],[61,17,61,18,1],[62,21,62,59,1],[63,21,63,70,1],[64,21,64,63,1],[65,21,65,58,1],[68,29,68,75,1],[69,29,69,35,1],[71,29,71,76,0],[72,29,72,35,0],[74,29,74,75,1],[75,29,75,35,1],[79,21,79,73,1],[80,21,80,22,1],[81,25,81,65,1],[82,21,82,22,1],[84,21,84,73,1],[85,21,85,22,1],[86,25,86,65,1],[87,21,87,22,1],[89,21,89,69,1],[91,21,91,62,1],[92,17,92,18,1],[94,17,94,24,1],[94,26,94,45,1],[94,46,94,48,1],[94,49,94,72,1],[95,17,95,18,1],[96,21,97,116,1],[98,17,98,18,1],[100,17,100,24,1],[100,26,100,49,1],[100,50,100,52,1],[100,53,100,80,1],[101,17,101,18,1],[102,21,104,57,1],[105,17,105,18,1],[108,17,108,53,1],[109,13,109,14,1],[110,13,110,32,0],[111,13,111,14,0],[112,17,112,38,0],[113,17,113,23,0],[117,13,117,27,1],[118,9,118,10,1],[126,9,126,10,1],[127,13,127,79,1],[130,13,130,34,1],[130,35,130,48,1],[132,13,132,85,1],[133,20,133,57,1],[134,13,134,14,1],[135,17,135,40,1],[137,17,137,123,1],[139,17,139,42,1],[141,17,141,71,1],[143,17,143,40,1],[145,17,145,110,1],[146,17,146,110,1],[148,17,148,130,1],[150,17,150,124,1],[153,17,153,126,1],[155,17,155,172,1],[156,17,156,42,1],[157,13,157,14,1],[159,13,159,25,1],[160,9,160,10,1],[163,9,163,10,1],[164,13,164,65,1],[166,13,166,20,1],[166,22,166,39,1],[166,40,166,42,1],[166,43,166,66,1],[167,13,167,14,1],[168,17,169,42,1],[169,42,169,70,1],[169,70,169,72,1],[168,17,169,72,1],[170,17,170,54,1],[171,17,171,18,1],[172,21,173,39,1],[173,39,173,88,1],[173,88,173,90,1],[172,21,173,90,1],[175,21,175,28,1],[175,30,175,62,1],[175,63,175,65,1],[175,66,175,95,1],[176,21,176,22,1],[177,25,177,63,1],[179,25,179,83,1],[180,25,180,73,1],[181,25,181,111,1],[181,111,181,149,1],[181,149,181,154,1],[181,25,181,154,1],[182,25,182,64,1],[183,21,183,22,1],[185,17,185,18,1],[186,13,186,14,1],[190,13,190,20,1],[190,22,190,43,1],[190,44,190,46,1],[190,47,190,74,1],[191,13,191,14,1],[192,17,193,42,1],[193,42,193,74,1],[193,74,193,76,1],[192,17,193,76,1],[194,17,194,58,1],[195,17,195,18,1],[196,21,197,39,1],[197,39,197,93,1],[197,93,197,95,1],[196,21,197,95,1],[199,21,199,28,1],[199,30,199,58,0],[199,59,199,61,1],[199,62,199,87,1],[200,21,200,22,0],[201,25,201,63,0],[203,25,203,81,0],[204,25,205,50,0],[205,50,205,84,0],[205,84,205,89,0],[204,25,205,89,0],[206,25,206,81,0],[207,25,207,64,0],[208,21,208,22,0],[210,17,210,18,1],[211,13,211,14,1],[213,13,213,68,1],[214,9,214,10,1],[217,9,217,10,1],[218,13,218,63,1],[220,13,220,20,1],[220,22,220,39,1],[220,40,220,42,1],[220,43,220,66,1],[221,13,221,14,1],[222,17,222,24,1],[222,26,222,51,1],[222,52,222,54,1],[222,55,222,91,1],[223,17,223,18,1],[224,21,226,29,1],[226,29,226,60,1],[226,60,226,62,1],[224,21,226,62,1],[228,21,228,91,1],[228,91,228,115,1],[228,115,228,117,1],[228,21,228,117,1],[231,21,231,56,1],[232,21,232,22,1],[233,25,233,162,1],[234,25,234,48,1],[235,25,235,26,1],[236,29,236,67,1],[237,29,237,62,1],[238,29,239,61,1],[240,29,240,64,1],[241,29,241,30,0],[242,33,242,102,0],[243,29,243,30,0],[245,29,245,30,1],[246,33,246,81,1],[247,29,247,30,1],[249,29,249,73,1],[250,29,250,30,0],[251,33,251,113,0],[252,29,252,30,0],[254,29,254,30,1],[255,33,255,62,1],[256,33,256,34,1],[257,37,257,98,1],[258,33,258,34,1],[259,29,259,30,1],[260,29,260,66,1],[261,25,261,26,1],[262,21,262,22,1],[264,17,264,18,1],[265,13,265,14,1],[267,13,267,20,1],[267,22,267,43,1],[267,44,267,46,1],[267,47,267,74,1],[268,13,268,14,1],[269,17,269,24,1],[269,26,269,47,1],[269,48,269,50,1],[269,51,269,92,1],[270,17,270,18,1],[271,21,272,69,1],[272,69,272,96,1],[272,96,272,98,1],[271,21,272,98,1],[274,21,274,99,1],[274,99,274,127,1],[274,127,274,129,1],[274,21,274,129,1],[276,21,276,52,1],[277,21,277,22,1],[278,25,278,167,1],[279,25,279,48,1],[280,25,280,26,1],[281,29,281,67,1],[282,29,282,62,1],[283,29,284,59,1],[285,29,285,69,1],[286,29,286,30,0],[287,33,287,101,0],[288,29,288,30,0],[290,29,290,30,1],[291,33,291,86,1],[292,29,292,30,1],[294,29,294,68,1],[295,29,295,30,1],[296,33,296,114,1],[297,29,297,30,1],[299,29,299,30,0],[300,33,300,89,0],[301,29,301,30,0],[303,29,303,66,1],[304,25,304,26,1],[305,21,305,22,1],[306,17,306,18,1],[307,13,307,14,1],[309,13,309,63,1],[311,9,311,10,1],[314,9,314,10,1],[315,13,315,32,1],[317,20,317,57,1],[318,13,318,14,1],[319,17,319,40,1],[323,17,323,83,1],[325,17,325,42,1],[326,13,326,14,1],[328,13,328,27,1],[329,9,329,10,1],[332,9,332,10,1],[333,13,333,32,1],[334,20,334,57,1],[335,13,335,14,1],[336,17,336,40,1],[340,17,340,91,1],[342,17,342,42,1],[343,13,343,14,1],[346,13,346,27,1],[347,9,347,10,1],[350,9,350,10,1],[352,13,352,75,1],[352,75,352,87,1],[352,87,352,100,1],[352,100,352,171,1],[352,171,352,173,1],[352,13,352,173,1],[354,13,354,20,1],[354,22,354,48,0],[354,49,354,51,1],[354,52,354,67,1],[355,13,355,14,0],[356,17,356,124,0],[357,13,357,14,0],[359,13,359,75,1],[359,75,359,87,1],[359,87,359,100,1],[359,100,359,171,1],[359,171,359,173,1],[359,13,359,173,1],[361,13,361,20,1],[361,22,361,48,0],[361,49,361,51,1],[361,52,361,67,1],[362,13,362,14,0],[363,17,363,124,0],[364,13,364,14,0],[366,9,366,10,1],[369,9,369,10,1],[370,13,370,57,1],[371,13,371,69,1],[371,69,371,98,1],[371,98,371,109,1],[371,13,371,109,1],[372,13,372,73,1],[372,73,372,102,1],[372,102,372,113,1],[372,13,372,113,1],[373,13,373,77,1],[373,77,373,116,1],[373,116,373,150,1],[373,150,373,159,1],[373,77,373,159,1],[373,159,373,170,1],[373,13,373,170,1],[375,13,375,48,1],[376,13,376,14,1],[377,17,377,61,1],[379,17,379,24,1],[379,26,379,45,1],[379,46,379,48,1],[379,49,379,68,1],[380,17,380,18,1],[381,21,381,55,1],[382,21,382,53,1],[384,21,384,61,1],[385,21,385,66,1],[387,21,387,54,1],[390,29,390,61,1],[391,29,391,35,1],[393,29,393,61,1],[394,29,394,35,1],[396,29,396,62,0],[397,29,397,35,0],[400,21,400,49,1],[401,21,401,50,1],[404,29,404,47,1],[405,29,405,35,1],[407,29,407,47,0],[408,29,408,35,0],[411,21,411,67,1],[413,21,413,94,1],[416,21,416,54,1],[417,17,417,18,1],[419,17,419,24,1],[419,26,419,44,1],[419,45,419,47,1],[419,48,419,63,1],[420,17,420,18,1],[421,21,421,63,1],[423,17,423,18,1],[424,13,424,14,1],[426,13,426,52,1],[427,13,427,14,1],[428,17,428,65,1],[430,17,430,24,1],[430,26,430,46,1],[430,47,430,49,1],[430,50,430,73,1],[431,17,431,18,1],[432,21,432,55,1],[433,21,433,69,1],[434,21,434,62,1],[435,21,435,55,1],[438,29,438,61,1],[439,29,439,35,1],[441,29,441,61,1],[442,29,442,35,1],[444,29,444,62,0],[445,29,445,35,0],[448,21,448,49,1],[449,21,449,51,1],[452,29,452,47,1],[453,29,453,35,1],[455,29,455,47,1],[456,29,456,35,1],[459,21,459,68,1],[461,21,461,94,1],[463,21,463,58,1],[464,17,464,18,1],[466,17,466,68,1],[467,13,467,14,1],[469,13,469,52,1],[470,13,470,14,1],[472,17,472,65,1],[474,17,474,24,1],[474,26,474,46,1],[474,47,474,49,1],[474,50,474,73,1],[475,17,475,18,1],[476,21,476,151,1],[477,21,477,22,1],[478,25,478,59,1],[479,25,479,73,1],[480,25,480,76,1],[481,25,481,62,1],[482,21,482,22,1],[483,17,483,18,1],[485,17,485,68,1],[486,13,486,14,1],[488,13,488,27,1],[489,9,489,10,1],[492,9,492,10,1],[493,13,493,32,1],[495,13,495,88,1],[495,88,495,100,1],[495,100,496,27,1],[496,27,496,79,1],[496,79,496,81,1],[495,13,496,81,1],[498,13,498,96,1],[498,96,498,108,1],[498,108,499,27,1],[499,27,499,79,1],[499,79,499,81,1],[498,13,499,81,1],[501,13,501,87,1],[503,13,503,27,1],[504,9,504,10,1],[508,9,508,10,1],[509,13,509,57,1],[510,13,510,79,1],[510,79,510,97,1],[510,97,510,108,1],[510,13,510,108,1],[511,13,511,83,1],[511,83,511,101,1],[511,101,511,112,1],[511,13,511,112,1],[513,13,514,59,1],[514,59,514,106,1],[514,106,514,118,1],[514,118,514,127,1],[514,59,514,127,1],[514,127,514,138,1],[513,13,514,138,1],[517,13,517,50,1],[518,13,518,14,1],[519,17,519,77,1],[520,17,520,24,1],[520,26,520,53,1],[520,54,520,56,1],[520,57,520,78,1],[521,17,521,18,1],[522,21,523,100,1],[524,21,524,82,1],[525,21,525,70,1],[526,17,526,18,1],[530,17,530,77,1],[531,17,531,94,1],[531,94,531,123,1],[531,123,531,134,1],[531,17,531,134,1],[532,17,532,93,1],[535,13,535,14,1],[537,13,537,54,1],[538,13,538,14,1],[539,17,539,81,1],[540,17,540,24,1],[540,26,540,54,1],[540,55,540,57,1],[540,58,540,83,1],[541,17,541,18,1],[542,21,542,130,1],[543,17,543,18,1],[561,17,561,84,1],[563,17,563,100,1],[563,100,563,129,1],[563,129,563,142,1],[563,142,563,149,1],[563,149,563,160,1],[563,17,563,160,1],[565,17,565,65,1],[566,17,566,18,0],[567,21,567,99,0],[568,17,568,18,0],[570,17,570,102,1],[570,102,570,131,1],[570,131,570,144,1],[570,144,570,152,1],[570,152,570,163,1],[570,17,570,163,1],[572,17,572,100,1],[573,13,573,14,1],[575,13,575,54,1],[576,13,576,14,1],[577,17,577,81,1],[579,17,579,24,1],[579,26,579,54,1],[579,55,579,57,1],[579,58,579,83,1],[580,17,580,18,1],[581,21,581,98,1],[582,21,582,22,1],[583,25,584,106,1],[585,21,585,22,1],[586,17,586,18,1],[588,17,588,100,1],[590,17,590,102,1],[590,102,590,131,1],[590,131,590,142,1],[590,17,590,142,1],[591,17,591,100,1],[593,17,593,82,1],[594,13,594,14,1],[596,13,596,27,1],[597,9,597,10,1],[601,9,601,10,1],[602,13,602,57,1],[603,13,603,71,1],[603,71,603,89,1],[603,89,603,100,1],[603,13,603,100,1],[604,13,604,75,1],[604,75,604,93,1],[604,93,604,104,1],[604,13,604,104,1],[605,13,606,55,1],[606,55,606,98,1],[606,98,606,110,1],[606,110,606,119,1],[606,55,606,119,1],[606,119,606,130,1],[605,13,606,130,1],[608,13,608,46,1],[609,13,609,14,1],[610,17,610,69,1],[612,17,612,24,1],[612,26,612,49,1],[612,50,612,52,1],[612,53,612,70,1],[613,17,613,18,1],[614,21,614,109,1],[615,21,615,80,1],[616,21,616,65,1],[617,17,617,18,1],[621,17,621,69,1],[623,17,623,86,1],[623,86,623,111,1],[623,111,623,122,1],[623,17,623,122,1],[625,17,625,85,1],[628,13,628,14,1],[630,13,630,50,1],[631,13,631,14,1],[632,17,632,72,1],[634,17,634,24,1],[634,26,634,50,1],[634,51,634,53,1],[634,54,634,75,1],[635,17,635,18,1],[636,21,636,113,1],[637,17,637,18,1],[654,17,654,75,1],[656,17,656,91,1],[656,91,656,116,1],[656,116,656,129,1],[656,129,656,136,1],[656,136,656,147,1],[656,17,656,147,1],[658,17,658,61,1],[659,17,659,18,0],[660,21,660,91,0],[661,17,661,18,0],[664,17,664,93,1],[664,93,664,118,1],[664,118,664,131,1],[664,131,664,139,1],[664,139,664,150,1],[664,17,664,150,1],[665,17,665,92,1],[666,13,666,14,1],[668,13,668,50,1],[669,13,669,14,1],[670,17,670,73,1],[672,17,672,24,1],[672,26,672,50,1],[672,51,672,53,1],[672,54,672,75,1],[673,17,673,18,1],[674,21,674,90,1],[675,21,675,22,1],[676,25,676,118,1],[677,21,677,22,1],[678,17,678,18,1],[680,17,680,92,1],[681,17,681,94,1],[681,94,681,119,1],[681,119,681,130,1],[681,17,681,130,1],[682,17,682,91,1],[684,17,684,76,1],[685,13,685,14,1],[687,13,687,27,1],[688,9,688,10,1],[691,9,691,10,1],[692,13,692,28,1],[694,13,694,31,1],[696,13,696,84,1],[698,13,698,73,1],[700,13,700,31,1],[701,13,701,14,1],[702,17,702,40,1],[704,17,704,32,1],[705,13,705,14,1],[707,13,707,27,1],[708,9,708,10,1],[711,9,711,10,1],[712,13,712,32,1],[714,20,714,57,1],[715,13,715,14,1],[716,17,716,40,1],[720,17,720,75,1],[722,17,722,42,1],[723,13,723,14,1],[725,13,725,27,1],[726,9,726,10,1]]);
    </script>
  </body>
</html>