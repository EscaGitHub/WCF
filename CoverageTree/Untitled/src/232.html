<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>D:\!Work\!GIT\SWR-Conf\Source\SWR-ConfiguratorAPI\SWR-Configurator\View\Controls\DataGridDoubleColumn.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Globalization;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;

namespace Swr.Configurator.View.Controls
{
	public class DataGridDoubleColumn : DataGridTextColumn
	{
		protected override bool CommitCellEdit(FrameworkElement editingElement)
		{
			var edit = editingElement as TextBox;
			if (edit != null) edit.PreviewTextInput -= OnPreviewTextInput;
			return base.CommitCellEdit(editingElement);
		}

		protected override void CancelCellEdit(FrameworkElement editingElement, object uneditedValue)
		{
			var edit = editingElement as TextBox;
			if (edit != null) edit.PreviewTextInput -= OnPreviewTextInput;
			base.CancelCellEdit(editingElement, uneditedValue);
		}

		protected override object PrepareCellForEdit(FrameworkElement editingElement, RoutedEventArgs editingEventArgs)
		{
			var edit = editingElement as TextBox;
			if (edit != null) edit.PreviewTextInput += OnPreviewTextInput;

			return base.PrepareCellForEdit(editingElement, editingEventArgs);
		}

		private void OnPreviewTextInput(object sender, TextCompositionEventArgs e)
		{
			try
			{
				var tb = sender as TextBox;
				if (tb == null)
				{
					e.Handled = true;
					return;
				}

				if (IsValidForDoubleColumn(e.Text, tb.CaretIndex, tb.Text)) 
					return;
				e.Handled = true;
			}
			catch (Exception ex)
			{
				e.Handled = true;
			}
		}

		public static bool IsValidForDoubleColumn(string input, int index, string text)
		{
			string result;
			try
			{
				result = text.Insert(index, input);
			}
			catch (ArgumentOutOfRangeException)
			{
				return false;
			}
			double doubleValue;
			if (!double.TryParse(result.Replace(&#39;,&#39;, &#39;.&#39;), NumberStyles.Any, CultureInfo.InvariantCulture, out doubleValue) || doubleValue &lt; 0)
			{
				return false;
			}
			return true;
		}
	}

	public class DataGridIntColumn : DataGridTextColumn
	{
		protected override bool CommitCellEdit(FrameworkElement editingElement)
		{
			var edit = editingElement as TextBox;
			if (edit != null) edit.PreviewTextInput -= OnPreviewTextInput;
			return base.CommitCellEdit(editingElement);
		}

		protected override void CancelCellEdit(FrameworkElement editingElement, object uneditedValue)
		{
			var edit = editingElement as TextBox;
			if (edit != null) edit.PreviewTextInput -= OnPreviewTextInput;
			base.CancelCellEdit(editingElement, uneditedValue);
		}

		protected override object PrepareCellForEdit(FrameworkElement editingElement, RoutedEventArgs editingEventArgs)
		{
			var edit = editingElement as TextBox;
			if (edit != null) edit.PreviewTextInput += OnPreviewTextInput;

			return base.PrepareCellForEdit(editingElement, editingEventArgs);
		}

		private void OnPreviewTextInput(object sender, TextCompositionEventArgs e)
		{
			try
			{
				var tb = sender as TextBox;
				if (tb == null)
				{
					e.Handled = true;
					return;
				}


				if (IsValidForIntColumn(e.Text, tb.CaretIndex, tb.Text))
					return;
				e.Handled = true;
			}
			catch (Exception ex)
			{
				e.Handled = true;
			}
		}

		public static bool IsValidForIntColumn(string input, int index, string text)
		{
			string result;
			try
			{
				result = text.Insert(index, input);
			}
			catch (ArgumentOutOfRangeException)
			{
				return false;
			}

			int intValue;
			if (!int.TryParse(result, NumberStyles.Any, CultureInfo.InvariantCulture, out intValue) || intValue &lt; 1)
			{
				return false;
			}
			return true;
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[12,3,12,4,0],[13,4,13,41,0],[14,4,14,21,0],[14,22,14,66,0],[15,4,15,47,0],[16,3,16,4,0],[19,3,19,4,0],[20,4,20,41,0],[21,4,21,21,0],[21,22,21,66,0],[22,4,22,55,0],[23,3,23,4,0],[26,3,26,4,0],[27,4,27,41,0],[28,4,28,21,0],[28,22,28,66,0],[30,4,30,69,0],[31,3,31,4,0],[34,3,34,4,0],[36,4,36,5,0],[37,5,37,32,0],[38,5,38,20,0],[39,5,39,6,0],[40,6,40,23,0],[41,6,41,13,0],[44,5,44,64,0],[45,6,45,13,0],[46,5,46,22,0],[47,4,47,5,0],[48,4,48,24,0],[49,4,49,5,0],[50,5,50,22,0],[51,4,51,5,0],[52,3,52,4,0],[55,3,55,4,0],[58,4,58,5,0],[59,5,59,40,0],[60,4,60,5,0],[61,4,61,39,0],[62,4,62,5,0],[63,5,63,18,0],[66,4,66,135,0],[67,4,67,5,0],[68,5,68,18,0],[70,4,70,16,0],[71,3,71,4,0],[77,3,77,4,0],[78,4,78,41,0],[79,4,79,21,0],[79,22,79,66,0],[80,4,80,47,0],[81,3,81,4,0],[84,3,84,4,0],[85,4,85,41,0],[86,4,86,21,0],[86,22,86,66,0],[87,4,87,55,0],[88,3,88,4,0],[91,3,91,4,0],[92,4,92,41,0],[93,4,93,21,0],[93,22,93,66,0],[95,4,95,69,0],[96,3,96,4,0],[99,3,99,4,0],[101,4,101,5,0],[102,5,102,32,0],[103,5,103,20,0],[104,5,104,6,0],[105,6,105,23,0],[106,6,106,13,0],[110,5,110,61,0],[111,6,111,13,0],[112,5,112,22,0],[113,4,113,5,0],[114,4,114,24,0],[115,4,115,5,0],[116,5,116,22,0],[117,4,117,5,0],[118,3,118,4,0],[121,3,121,4,0],[124,4,124,5,0],[125,5,125,40,0],[126,4,126,5,0],[127,4,127,39,0],[128,4,128,5,0],[129,5,129,18,0],[133,4,133,108,0],[134,4,134,5,0],[135,5,135,18,0],[137,4,137,16,0],[138,3,138,4,0]]);
    </script>
  </body>
</html>